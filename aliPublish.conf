# vim: set filetype=yaml:
---
#base_url: http://test-results.marathon.mesos/TARS
base_url: http://188.184.162.83/TARS
architectures:
  slc5_x86-64:
    CVMFS: x86_64-2.6-gnu-4.1.2
    AliEn: Linux-x86_64
cvmfs_repository: alice-test.cern.ch
package_dir: /cvmfs/%(repo)s/%(arch)s/Packages/%(package)s/%(version)s
modulefile: /cvmfs/%(repo)s/%(arch)s/Modules/modulefiles/%(package)s/%(version)s
cvmfs_script: |
  #!/bin/bash -ex
  set -o pipefail
  cd /cvmfs/%(repo)s
  mkdir -p %(arch)s/Packages
  cd %(arch)s/Packages
  curl --silent -L %(url)s | tar --strip-components=2 -xzf -
  # Dereference hardlinks: CVMFS does not support them across dirs
  find %(pkgdir)s -not -type d -links +1 -exec \
    sh -ec 'cp -ip "{}" "{}".__DEREF__; mv "{}".__DEREF__ "{}"' \;
  export WORK_DIR=$PWD
  export PKGPATH=%(package)s/%(version)s
  sh -e %(pkgdir)s/relocate-me.sh
  MODULESRC=%(pkgdir)s/etc/modulefiles/%(package)s
  MODULEDST=%(modulefile)s
  [[ -e $MODULESRC ]]
  mkdir -p $(dirname $MODULEDST)
  cp -v $MODULESRC $MODULEDST
alien_script: |
  #!/bin/bash -ex
  set -o pipefail
  TMPDIR=$(mktemp -d /tmp/aliPublish.XXXXX)
  TORDIR=/var/packages/download
  TORNOTIFY=/var/packages/NEWFILE
  mkdir -p $TMPDIR
  cd $TMPDIR
  curl --silent -L %(url)s | tar --strip-components=3 -xzf -
  TAR=$(echo %(package)s|tr '[:upper:]' '[:lower:]')_%(version)s.%(arch)s.tar.gz
  tar czf $TAR %(version)s/
  rm -rf %(version)s/
  DEPS=%(dependencies)s
  alien -exec packman define %(package)s %(version)s $TMPDIR/$TAR ${DEPS:+dependencies=$DEPS} -vo -platform %(arch)s -se ALICE::CERN::EOS
  cp -f $TMPDIR/$TAR $TORDIR/$TAR
  chmod a=rw $TORDIR/$TAR
  touch $TORNOTIFY
  alien -exec addMirror /alice/packages/%(package)s/%(version)s/%(arch)s no_se torrent://alitorrent.cern.ch/torrents/$TAR.torrent
  rm -rf $TMPDIR
notification_email:
  server: cernmx.cern.ch
  package_format: "  VO_ALICE@%(package)s::%(version)s\n"
  success:
    body: |
      Dear ALICE fellows,

        %(package)s %(version)s was registered and it is ready to be used. While
      there is a delay of up to two hours before the tag is propagated on CVMFS,
      test trains can be run right away.

      This package has the following dependencies:

      %(dependencies_fmt)s
      If you launch Grid jobs, it is sufficient to specify this single package in
      the JDL like this:

        Packages = {
          "VO_ALICE@%(package)s::%(version)s"
        }

      Do not specify explicitly any of the above dependencies: all the correct ones
      will be automatically available in the job's environment.

      You can use the CVMFS package from lxplus like this:

        source /cvmfs/alice.cern.ch/etc/login.sh
        alienv enter VO_ALICE@%(package)s::%(version)s

      For inquiries and problems use our ALICE JIRA: https://alice.its.cern.ch/
      Full list of packages available on the Grid: http://alimonitor.cern.ch/packages/

      Enjoy,
      --
      The ALICE Build Infrastructure
    subject: "[AliBuild] %(package)s %(version)s on the Grid"
    from: "ALICE Builder <alice-analysis-operations@cern.ch>"
    to: alice-analysis-operations@cern.ch
  failure:
    body: |
      CVMFS publishing failed for %(package)s %(version)s. Please have a look.

      Cheers,
      --
      The ALICE Build Infrastructure
    subject: "[CVMFS] Failed: %(package)s %(version)s"
    from: "ALICE Builder <noreply@cern.ch>"
    to:
     - dario.berzano@cern.ch
     - giulio.eulisse@cern.ch
auto_include_deps: True
# Example of include before excluding
include:
  AliPhysics:
   - ^vAN-201[0-9][0-1][0-9][0-3][0-9]-[0-9]+$
   - ^v5-06-[0-9]+-01-[0-9]+$
   - ^v5-06-[0-9]+-01-dmesonaod[0-9]+-[0-9]+$
  AliRoot:
   - ^v5-05-Rev-.+$
  GEANT3:
   - ^v2-0-[0-9]+$
   - ^v1-15[a-z]+-[0-9]+$
  GEANT4_VMC:
   - ^v3-.+$
exclude:
  AliPhysics:
   - ^vAN-20150910.*$
   - ^vAN-2015090.*$
  GEANT3:
   - ^v2-0-[1-6]$
filter_order: include,exclude

# Example of exclude before including: sync all, exclude AliRoot-test
#exclude:
#  AliRoot-test: True
#include:
#filter_order: exclude,include
